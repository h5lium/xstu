

<h2>学生学籍</h2>

<ul id="profile" class="list-group hidden"></ul>

<script>
(function() {
	var client = global.client,
		$profile = $('#profile');
	
	if (global.profile) {
		displayProfile(global.profile);
	} else {
		client.get('/student/f1.asp', {}, {}, function(err, res, body) {
			displayProfile(global.profile = parseProfile(body));
		});
	}
	
	function displayProfile(profile) {
		var titles = {
			code: '学号', name: '姓名', avatar: '头像', politics: '政治面貌',
			sex: '性别', birth: '出生年月', nation: '民族', major: '专业',
			class: '班级', college: '学院', entrance: '入学日期', dormitory: '宿舍地址'
		}, $li, html;
		_.each(profile, function(val, key) {
			$li = $('<li class="list-group-item"></li>');
			html = '<strong>'+ titles[key] +': </strong>';
			if (key === 'avatar') {
				html += '<img src="http://jwc.wyu.cn/student/'+ val +'">';
			} else {
				html += '<span>'+ val +'</span>';
			}
			$li.html(html).appendTo($profile);
		});
		$profile.removeClass('hidden');
	}
	function parseProfile(html) {
	    html = html.replace(/\r\n/g, '');
	    var tableHtml = html.match(/<table.+<\/table>/)[0],
	        $table = $(tableHtml),
	        $trs = $table.find('tr');
	    return {
	        code: $trs.eq(0).find('td').eq(1).text(),
	        name: $trs.eq(0).find('td').eq(3).text(),
	        avatar: $trs.eq(0).find('td').eq(6).find('img').attr('src'),
	        politics: $trs.eq(2).find('td').eq(3).text(),
	        sex: $trs.eq(1).find('td').eq(1).text(),
	        birth: $trs.eq(1).find('td').eq(3).text(),
	        nation: $trs.eq(1).find('td').eq(5).text(),
	        major: $trs.eq(3).find('td').eq(1).text(),
	        class: $trs.eq(3).find('td').eq(3).text(),
	        college: $trs.eq(4).find('td').eq(1).text(),
	        entrance: $trs.eq(5).find('td').eq(3).text(),
	        dormitory: $trs.eq(8).find('td').eq(5).text()
	    }
	}
})();
</script>